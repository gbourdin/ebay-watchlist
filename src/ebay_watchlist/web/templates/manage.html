<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Manage Watchlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
</head>
<body class="bg-light py-4">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h4 mb-1">Manage Watchlist</h1>
            <p class="text-muted mb-0">Add or remove watched sellers and categories.</p>
        </div>
        <a href="{{ reset_url }}" class="btn btn-outline-primary btn-sm">Back to Listings</a>
    </div>

    {% if message %}
        <div class="alert alert-{{ message_level }} py-2" role="alert">
            {{ message }}
        </div>
    {% endif %}

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <span class="fw-semibold">Watched Sellers</span>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('main.manage_watchlist') }}" class="mb-3">
                        <input type="hidden" name="action" value="add_seller">
                        <label for="seller_name" class="form-label small text-uppercase text-muted mb-1">Add Seller</label>
                        <div class="input-group">
                            <input id="seller_name" name="seller_name" class="form-control" placeholder="ebay username">
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </form>

                    {% if watched_sellers %}
                        <ul class="list-group list-group-flush">
                            {% for seller in watched_sellers %}
                                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">{{ seller }}</span>
                                    <form method="post" action="{{ url_for('main.manage_watchlist') }}" class="m-0">
                                        <input type="hidden" name="action" value="remove_seller">
                                        <input type="hidden" name="seller_name" value="{{ seller }}">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Remove</button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">No watched sellers configured.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <span class="fw-semibold">Watched Categories</span>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('main.manage_watchlist') }}" class="mb-3" id="add-category-form">
                        <input type="hidden" name="action" value="add_category">
                        <input type="hidden" name="category_id" id="selected-category-id">
                        <label for="category-search" class="form-label small text-uppercase text-muted mb-1">Add Category</label>
                        <input
                            id="category-search"
                            name="category"
                            class="form-control"
                            list="category-options"
                            placeholder="Search category by name (or type numeric id)"
                            autocomplete="off"
                        >
                        <datalist id="category-options">
                            {% for option in category_options %}
                                <option value="{{ option }}"></option>
                            {% endfor %}
                        </datalist>
                        <div id="category-suggestions" class="list-group mt-2"></div>
                        <div class="form-text mb-2">Stores watched categories by numeric ID.</div>
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </form>

                    {% if watched_categories %}
                        <ul class="list-group list-group-flush">
                            {% for category in watched_categories %}
                                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fw-semibold">{{ category.name }}</span>
                                        <span class="text-muted small ms-2">ID: {{ category.id }}</span>
                                    </div>
                                    <form method="post" action="{{ url_for('main.manage_watchlist') }}" class="m-0">
                                        <input type="hidden" name="action" value="remove_category">
                                        <input type="hidden" name="category_id" value="{{ category.id }}">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Remove</button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted mb-0">No watched categories configured.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function () {
    const input = document.getElementById("category-search");
    const selectedId = document.getElementById("selected-category-id");
    const resultsContainer = document.getElementById("category-suggestions");
    const form = document.getElementById("add-category-form");
    let debounceTimer = null;

    function clearSuggestions() {
        if (resultsContainer) {
            resultsContainer.innerHTML = "";
        }
    }

    function selectSuggestion(suggestion) {
        if (!input || !selectedId) {
            return;
        }

        input.value = suggestion.path || suggestion.name;
        selectedId.value = suggestion.id;
        clearSuggestions();
    }

    function renderSuggestions(suggestions) {
        if (!resultsContainer) {
            return;
        }

        resultsContainer.innerHTML = "";
        suggestions.forEach((suggestion) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "list-group-item list-group-item-action";
            button.textContent = `${suggestion.path} (ID: ${suggestion.id})`;
            button.addEventListener("click", () => {
                selectSuggestion(suggestion);
            });
            resultsContainer.appendChild(button);
        });
    }

    async function fetchSuggestions(query) {
        const response = await fetch(`/manage/category-suggestions?q=${encodeURIComponent(query)}`);
        if (!response.ok) {
            return [];
        }
        const payload = await response.json();
        return payload.suggestions || [];
    }

    if (input && selectedId) {
        input.addEventListener("input", () => {
            selectedId.value = "";
            const query = input.value.trim();

            if (debounceTimer) {
                window.clearTimeout(debounceTimer);
            }

            if (query.length < 2) {
                clearSuggestions();
                return;
            }

            debounceTimer = window.setTimeout(async () => {
                const suggestions = await fetchSuggestions(query);
                renderSuggestions(suggestions);
            }, 200);
        });
    }

    if (form && input && selectedId) {
        form.addEventListener("submit", () => {
            const typedValue = input.value.trim();
            if (!selectedId.value && /^\d+$/.test(typedValue)) {
                selectedId.value = typedValue;
            }
        });
    }
})();
</script>
</body>
</html>
